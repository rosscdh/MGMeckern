{% load i18n leaflet_tags crispy_forms_tags templatetag_handlebars markup %}

<style>
    div.leaflet-control-geosearch {
        display:none;
    }
    div#mg_meckern {
        min-height:460px;
    }
</style>

<div class="container">
    <div class="page-header text-center">
        <h2>{% trans 'Where is the problem?' %}</h2>
        <small>{% trans 'So you have found a problem that you think needs to be looked at or repaired?' %}</small>
    </div>
</div>

<div class="row">
    <span id="mgmeckern-map">{% leaflet_map map_name callback="window.map_init_basic" %}</span>
    <div class="row text-center">
        <small>{% trans 'Enter the street address or use the map to find the location of the problem you would like to report.' %}</small><br/>
        <small>{% trans 'Double cick the map to add a new report!' %}</small>
    </div>
</div>

<div class="container">
    <div class="row page-header text-center">
        {% crispy search_form %}
    </div>
</div>

{% tplhandlebars "tpl-report_form" %}
    {% crispy report_form %}
{% endtplhandlebars %}

{% tplhandlebars "tpl-report" %}
<div class="label {{ css_severity }} pull-right">{{ display_severity }}</div>
<blockquote>{{ comment }}<small>{{ date_modified }}</small></blockquote>
{% endtplhandlebars %}

<script type="text/javascript">
'use strict';

/**
* Map Plugin & Controls
* for the mgmeckern-app
*/
$(function() {

    $.widget( "mgmeckern.map_control", {
        map: null,
        geo_search: null,
        current_marker: null,  // the currently selected marker - as leaf does not seem to prvide a way to get a popups bound marker
        report_form_popup: null, // the popup that consistenly provides the form
        entered_data: {},
        // templates
        templates: {
            'report_form': null,
            'report': null,
        },
        // default options
        options: {
            'map': null,
            'map_options': null,
            'create_report_url': null,
            'q': $('#id_q'), // address search element
            'search_btn': $('input#search-btn'), // address search button
            'add_marker_btn': $('input#add-marker-btn'),    // add marker button
            'report_form_tpl': $('script#tpl-report_form'), // the report form template
            'report_tpl': $('script#tpl-report'),   // the report display template
            'debug': true
        },
        _log: function ( msg ) {
            var self = this;
            if ( self.options.debug === true ) {
                console.log( msg )
            }
        },
        // the constructor
        _create: function () {
            var self = this;
            self._log('creating')

            self.set_templates();
            self._controls();
            self._listen();

            // if we have the map and map options passed in
            // then init the map
            if ( self.options.map && self.options.map_options ) {
                self.init_map(self.options.map, self.options.map_options);
            }

            // assign to window so we can access it
            if (self.options.debug === true)
                window.map_control = self;
        },
        _controls: function () {
            var self = this;
            self._log('setting controls');
            // setup the reuseable report form
            self.report_form_popup = self.init_report_form_popup();

            // hide the add-maker-btn by default
            self.options.add_marker_btn.addClass('hide');
        },
        _listen: function () {
            var self = this;
            self._log('listening');

            // global new search event
            $('body').on('new_search', function ( e ) {
                self._log('new_search');
                // hide the add markert button
                self.options.add_marker_btn.addClass('hide');
    
                if ( self.options.q )
                    self._log('have a q element');
                    var qry = self.options.q.val();
                    if (qry !== '') {
                        self._log('q element value is present');
                        self._log('sending geosearch query');
                        self.geo_search.geosearch(qry);
                    }
    
            });

            // global add marker event
            $('body').on('add_marker', function ( e ) {
                self._log('add_marker');
                self.map.fireEvent( "add_report_marker");
            });

            // found geosearch results
            $('body').on('geosearch_results_found', function ( e ) {
                self._log('found geosearch results');
                // show the add_marker btn
                self.options.add_marker_btn.removeClass('hide');
            });

            // populate the report form
            $('body').on( "populate_report_form", function( event, map, latlng, marker ) {
                self._log('populate_report_form');

                var address = (self.entered_data.id_address || self.options.q.val() || null);

                if ( address === null) {
                    $('#div_id_address:first').hide(); // hide the outer parent row
                    $('#id_address:first').val( '' );
                } else {
                    $('#div_id_address:first').show(); // show the outer parent row
                    $('#id_address:first').val( address );
                }

                $('#id_comment:first').val( self.entered_data.id_comment || '');
                $('#id_email:first').val( self.entered_data.id_email || '');
                $('#id_lat:first').val(latlng.lat.toFixed(15));
                $('#id_lon:first').val(latlng.lng.toFixed(15));

                // setup fhe form
                $('body').trigger( "form_init", [map, latlng, marker] )
            });

            // form initialization and parslification
            $('body').on( "form_init", function( event, map, latlng, marker ) {
                self._log('report form_init');

                var form = $( '#frm-create-report' );
                form.parsley();

                $('#frm-create-report textarea').on('change', function ( e ) {
                    console.log('settings value')
                    var elem = $(e.target);
                    self.entered_data[elem.attr('id')] = elem.val();
                });

                // stop the ormal form submit action from happening
                $("#frm-create-report").off('submit').on('submit', function ( e ) {
                    console.log('form submit: frm-create-report')
                    e.preventDefault();
                    e.stopPropagation();
                });

                $('#id_btn-send-report').off('click').on("click", function ( e ) {
                    e.preventDefault();

                    self._log('send report')

                    if ( form.parsley( 'validate' ) === true ) {
                        $.ajax({
                            type: 'POST',
                            url: self.options.create_report_url,
                            data: form.serialize(),
                            context: this,
                            success: function(data, status) {
                                // ok so we have a winner
                                self.current_marker.closePopup();
                                var pk = data.id
                                // update with nice template data
                                var popup = L.popup().setContent(self.templates.report(data))
                                // bind to the new popup
                                self.current_marker.bindPopup(popup);
                                // now open it
                                self.current_marker.openPopup();
                                // reset data
                                self.entered_data = {};
                            }
                        });
                    }
                });
            });

            /**
            * button controls
            */
            self.options.search_btn.on('click', function ( e ) {
                e.preventDefault();
                e.stopPropagation();

                self._log('trigger new_search');
                $('body').trigger('new_search');
            });

            self.options.add_marker_btn.on('click', function ( e ) {
                e.preventDefault();
                e.stopPropagation();

                self._log('trigger add_marker');
                $('body').trigger('add_marker');
            });

        },
        set_templates: function () {
            var self = this;
            self._log('setting templates');
            self.templates.report_form = Handlebars.compile( self.options.report_form_tpl.html() );
            self.templates.report = Handlebars.compile( self.options.report_tpl.html() );
        },
        geosearch_provider: function () {
            var self = this;
            self._log('getting the geosearch provider');
            return new L.Control.GeoSearch({
                        showMarker: false,
                        provider: new L.GeoSearch.Provider.OpenStreetMap()
                    })
        },
        init_report_form_popup: function () {
            var self = this;
            return L.popup({ 
                        minWidth: 400,
                        maxWidth: 450
                    })
                    .setContent(
                        self.templates.report_form({}) // init the basic form template
                    );
        },
        /**
        * This method is called from the django-leaf callback
        */
        init_map: function (map, options) {
            var self = this;
            var marker = null;
            self.map = map;
            self._log('initializing the map');

            self.map.doubleClickZoom.disable();

            // Add marker pins for existing events
            // @TODO this wil need to become a rest call eventually
            {% for p in pins %}
                marker = L.marker([{{ p.lat }}, {{ p.lon }}]);

                var report_popupContent = self.templates.report({
                    'comment': '{{ p.comment|escapejs }}',
                    'date_modified': '{{ p.date_modified }}',
                    'display_severity': '{{ p.display_severity }}',
                    'css_severity': '{{ p.css_severity }}',
                });
                marker.pk = {{ p.pk }}; // used to identify it as "set"
                marker.bindPopup(report_popupContent);
                marker.addTo(self.map);
            {% endfor %}

            // Geo Search
            self.geo_search = self.geosearch_provider();
            self.geo_search.addTo(self.map);


            // setup the map listeners
            self._map_listen(map);
        },
        /**
        * Listeners that are specific to our map instance
        */
        _map_listen: function ( map ) {
            var self = this;

            map.on('add_report_marker', function ( e ) {
                // console.log('dblclick')
                var latlng = e.latlng || map.getCenter();
                var marker = new L.Marker(latlng, {title: 'New Report', draggable: true, riseOnHover: true})
                marker.pk = null; // used to id our map markers

                marker.addTo(map)
                      .bindPopup(self.report_form_popup)
                      .openPopup();

                self.current_marker = marker;

                $('body').trigger('populate_report_form', [map, latlng, marker]);
            });

            /**
            * on double click on map then add the report marker
            */
            map.on("dblclick", function ( e ) {
                self.map.fireEvent( "add_report_marker", {latlng: e.latlng} );
            })
            /**
            * fire the show marker button
            */
            map.on('geosearch_showlocation', function ( e ) {
                $('body').trigger( "geosearch_results_found" );
            })

            map.on('popupopen', function ( e ) {
                /**
                * fire this event when we are looking at a new report form popup
                */
                if ( e.popup == self.report_form_popup ) {
                    var latlng = e.popup._latlng;
                    var marker = e.target;
                    $('body').trigger('populate_report_form', [map, latlng, marker]);
                }
            });
        }
    });

});

/**
* Callback called by leaf js when the map is loaded
*/
function map_init_basic (map, options) {
    // initialize our map
    $('#mgmeckern-map').map_control({
            'map':map,
            'map_options': options,
            'create_report_url': '{{ report_api_url }}'
    });
}

$(document).ready(function(){

    $('#div_id_q').addClass('col-md-10');

    $('form#frm-address-search').keypress( function ( e ) {
        if ( e.keyCode == 10 || e.keyCode == 13 ) {
            e.preventDefault();
            e.stopPropagation();
            // trigger the search click event
            window.map_control.options.search_btn.trigger('click');
        }
    });

});
</script>