{% load url from future %}{% load i18n leaflet_tags crispy_forms_tags templatetag_handlebars l10n thumbnail %}

<span id="{{ map_selector }}">{% leaflet_map map_name callback=map_init_callback %}</span>

<style>
    div.leaflet-control-geosearch {
        display:none;
    }
    div#mg_meckern {
        min-height:100%;
        min-width:100%;
    }
    iframe#id_report_form_create{
        width:100%;
        height:100%;
    }
</style>

{% tplhandlebars "tpl-report_form" %}
    <iframe id="id_report_form_create" src="{% url 'report:create' %}" frameborder="0" style="margin:0px;height:560px"></iframe>
{% endtplhandlebars %}

{% tplhandlebars "tpl-report" %}
<div class="row">
    <blockquote>
        <img class="pull-right" src="{{ photo }}" border="0"/>
        {{ comment }}
        <small>{{ date_modified }}</small>
    </blockquote>
</div>
{% endtplhandlebars %}

<script type="text/javascript">
'use strict';

/**
* Map Plugin & Controls
* for the mgmeckern-app
*/
$(function() {

    $.widget( "mgmeckern.map_control", {
        map: null,
        geo_search: null,
        current_marker: null,  // the currently selected marker - as leaf does not seem to prvide a way to get a popups bound marker
        report_form_popup: null, // the popup that consistenly provides the form
        entered_data: {},
        iframe: null,
        // templates
        templates: {
            'report_form': null,
            'report': null,
        },
        // default options
        options: {
            'map': null,
            'map_options': null,
            'create_report_url': null,
            'q': $('#id_q'), // address search element
            'search_btn': $('input#search-btn'), // address search button
            'add_marker_btn': $('input#add-marker-btn'),    // add marker button
            'report_form_tpl': $('script#tpl-report_form'), // the report form template
            'report_tpl': $('script#tpl-report'),   // the report display template
            'pins': [],
            'debug': true
        },
        _log: function ( msg ) {
            var self = this;
            if ( self.options.debug === true ) {
                console.log( msg )
            }
        },
        // the constructor
        _create: function () {
            var self = this;
            self._log('creating')

            self.iframe = $('#id_report_form_create').contents();

            self.set_templates();
            self._controls();
            self._listen();

            // if we have the map and map options passed in
            // then init the map
            if ( self.options.map && self.options.map_options ) {
                self.init_map(self.options.map, self.options.map_options);
            }

            // assign to window so we can access it
            if (self.options.debug === true)
                window.map_control = self;
        },
        _controls: function () {
            var self = this;
            self._log('setting controls');
            // setup the reuseable report form
            self.report_form_popup = self.init_report_form_popup();

            // hide the add-maker-btn by default
            self.options.add_marker_btn.addClass('hide');
        },
        _listen: function () {
            var self = this;
            self._log('listening');

            // global new search event
            $('body').on('new_search', function ( e ) {
                self._log('new_search');
                // hide the add markert button
                self.options.add_marker_btn.addClass('hide');
    
                if ( self.options.q )
                    self._log('have a q element');
                    var qry = self.options.q.val();
                    if (qry !== '') {
                        self._log('q element value is present');
                        self._log('sending geosearch query');
                        self.geo_search.geosearch(qry);
                    }
    
            });

            // global add marker event
            $('body').on('add_marker', function ( e ) {
                self._log('add_marker');
                self.map.fireEvent( "add_report_marker");
            });

            // found geosearch results
            $('body').on('geosearch_results_found', function ( e ) {
                self._log('found geosearch results');
                // show the add_marker btn
                self.options.add_marker_btn.removeClass('hide');
            });

            // populate the report form
            $('body').on( "populate_report_form", function( event, map, latlng, marker ) {
                self._log('populate_report_form');

                $('#id_report_form_create').on('load', function ( e ) {
                    // set the self iframe
                    self._log('loaded iframe')

                    self.iframe = $(this).contents();
                    try {
                        var json = $.parseJSON(self.iframe.text());
                        $('body').trigger( "form_submitted", [json] )

                    } catch ( e ) {
                        var json = false;
                        var address = (self.entered_data.id_address || self.options.q.val() || null);

                        if ( address === null) {
                            self.iframe.find('#div_id_address:first').hide(); // hide the outer parent row
                            self.iframe.find('#id_address:first').val( '' );
                        } else {
                            self.iframe.find('#div_id_address:first').show(); // show the outer parent row
                            self.iframe.find('#id_address:first').val( address );
                        }

                        self.iframe.find('#id_comment:first').val( self.entered_data.id_comment || '');
                        self.iframe.find('#id_email:first').val( self.entered_data.id_email || '');
                        self.iframe.find('#id_lat:first').val(latlng.lat.toFixed(15));
                        self.iframe.find('#id_lon:first').val(latlng.lng.toFixed(15));

                        // setup fhe form
                        $('body').trigger( "form_init", [map, latlng, marker] )
                    }
                })// end iframe load

            });

            // form initialization and parslification
            $('body').on( "form_init", function( event, map, latlng, marker ) {
                self._log('report form_init');

                var form = self.iframe.find( '#frm-create-report' );
                //form.parsley();

                form.find('#frm-create-report textarea').on('change', function ( e ) {
                    console.log('settings value')
                    var elem = $(e.target);
                    self.entered_data[elem.attr('id')] = elem.val();
                });

                form.on('submit', function ( e ) {
                    console.log(self.iframe)
                })

            });

            $('body').on( "form_submitted", function ( event, json ) {
                // ok so we have a winner
                self.current_marker.closePopup();
                var pk = json.id
                // update with nice template json
                var popup = L.popup().setContent(self.templates.report(json))
                // bind to the new popup
                self.current_marker.bindPopup(popup, {minWidth: 300});
                // now open it
                self.current_marker.openPopup();
                // reset json
                self.entered_data = {};
            })

            /**
            * button controls
            */
            self.options.search_btn.on('click', function ( e ) {
                e.preventDefault();
                e.stopPropagation();

                self._log('trigger new_search');
                $('body').trigger('new_search');
            });

            self.options.add_marker_btn.on('click', function ( e ) {
                e.preventDefault();
                e.stopPropagation();

                self._log('trigger add_marker');
                $('body').trigger('add_marker');
            });

        },
        set_templates: function () {
            var self = this;
            self._log('setting templates');
            self.templates.report_form = Handlebars.compile( self.options.report_form_tpl.html() );
            self.templates.report = Handlebars.compile( self.options.report_tpl.html() );
        },
        geosearch_provider: function () {
            var self = this;
            self._log('getting the geosearch provider');
            return new L.Control.GeoSearch({
                        showMarker: false,
                        provider: new L.GeoSearch.Provider.OpenStreetMap()
                    })
        },
        init_report_form_popup: function () {
            var self = this;
            return L.popup({ 
                        minWidth: 600,
                        maxWidth: 640
                    })
                    .setContent(
                        self.templates.report_form({}) // init the basic form template
                    );
        },
        /**
        * This method is called from the django-leaf callback
        */
        init_map: function (map, options) {
            var self = this;
            var marker = null;
            self.map = map;
            self.map.markers = []; // container for our markers

            self._log('initializing the map');

            self.map.doubleClickZoom.disable();

            // setup the map listeners
            self._map_listen(map);

            // Add marker pins for existing events
            // 
            /*
            * Expects an object like
            *
                {
                    'comment': '{{ p.comment|escapejs }}',
                    'photo': '{% if p.photo %}{% thumbnail p.photo 75x75 crop %}{% endif %}',
                    'date_modified': '{{ p.date_modified }}',
                    'display_severity': '{{ p.display_severity }}',
                    'css_severity': '{{ p.css_severity }}',
                }
            */
            var report_popupContent = null;
            $.each(self.options.pins, function (i, item) {
                report_popupContent = self.templates.report(item);
                self.map.fireEvent( "add_marker", {lat: item.lat, lon: item.lon, template: report_popupContent} );
            })

            // Geo Search
            self.geo_search = self.geosearch_provider();
            self.geo_search.addTo(self.map);
        },
        /**
        * Listeners that are specific to our map instance
        */
        _map_listen: function ( map ) {
            var self = this;

            map.on('add_report_marker', function ( e ) {
                // console.log('dblclick')
                var latlng = e.latlng || map.getCenter();
                var marker = new L.Marker(latlng, {title: 'New Report', draggable: true, riseOnHover: true})
                marker.pk = null; // used to id our map markers

                marker.addTo(map)
                      .bindPopup(self.report_form_popup)
                      .openPopup();

                self.current_marker = marker;

                $('body').trigger('populate_report_form', [map, latlng, marker]);
            });

            map.on('add_marker', function ( e ) {
                var marker = L.marker([e.lat, e.lon]);
                var template = e.template;
                var open = e.open || false;

                marker.addTo(this)
                      .bindPopup(template, {minWidth: 300});
                if ( open === true ) {
                    marker.openPopup();
                }

                self._log('Added pin to map')
            });

            /**
            * on double click on map then add the report marker
            */
            map.on("dblclick", function ( e ) {
                self.map.fireEvent( "add_report_marker", {latlng: e.latlng} );
            })
            /**
            * fire the show marker button
            */
            map.on('geosearch_showlocation', function ( e ) {
                $('body').trigger( "geosearch_results_found" );
            })

            map.on('popupopen', function ( e ) {
                /**
                * fire this event when we are looking at a new report form popup
                */
                if ( e.popup == self.report_form_popup ) {
                    var latlng = e.popup._latlng;
                    var marker = e.target;
                    $('body').trigger('populate_report_form', [map, latlng, marker]);
                }
            });
        }
    });

});
</script>